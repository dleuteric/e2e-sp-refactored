# Default configuration for the tracking_performance repository.
# Each key is documented inline; overrides are possible via env/CLI.
# === PROJECT STRUCTURE ===
project:
  root: .  # Will be resolved to absolute path
  exports_root: exports

paths:
  # Flight dynamics
  ephemeris:
    raw: exports/ephemeris
    aligned_satellites: exports/aligned_ephems/satellite_ephems
    aligned_targets: exports/aligned_ephems/targets_ephems

  # Geometry
  geometry:
    los: exports/geometry/los
    gpm: exports/gpm

  # Tracking
  tracking:
    tracks: exports/tracks
    performance: exports/tracking_performance

  # Communications
  comms:
    data_age: exports/comms/data_age
    provenance: exports/comms/provenance
    onboard: exports/comms/onboard_processing
    network: exports/comms/network

  # Orchestration
  orchestrator:
    base: exports/orchestrator
    manifests: exports/orchestrator/manifests

  # Reporting
  reports:
    base: exports/reports
    figures: exports/reports/figures
    html: exports/reports/html
    pdf: exports/reports/pdf

  # Target exports (legacy?)
  target_exports: exports/target_exports/OUTPUT_CSV

# === FILENAME PATTERNS ===
patterns:
  satellite_ephemeris: "*.csv"
  target_ephemeris: "HGV_*.csv"
  los_csv: "LOS_{sat_id}_{target_id}.csv"
  gpm_csv: "GPM_{target_id}_{sat_a}_{sat_b}.csv"
  track_csv: "{target_id}_track_{backend}.csv"
  manifest: "manifest.json"

# === RUN MANAGEMENT ===
runtime:
  run_id_format: "%Y%m%dT%H%M%SZ"  # ISO 8601 UTC
  run_id_env_var: ORCH_RUN_ID
  auto_timestamp: true
  preserve_runs: true  # Keep old runs or clean

flightdynamics:
  earth:
    mu: 398600.4418          # km^3/s^2 — Earth gravitational parameter (WGS-84)
    J2: 1.08262668e-3        # dimensionless — J2 oblateness coefficient
    R_E: 6378.137            # km — Earth equatorial radius (semi-major axis)
    omega_E: 7.2921159e-5    # rad/s — Earth rotation rate
  space_segment:
    layers:
      - name: VLEO_FC
        enabled: false
        type: walker
        num_planes: 30
        sats_per_plane: 20
        walker_factor: 0
        altitude_km: 250
        inclination_deg: 60.0
        eccentricity: 0.001
        arg_perigee_deg: 0.0
        raan_spacing: uniform

      - name: LEO_FC
        enabled: true
        type: walker
        num_planes: 8
        sats_per_plane: 6
        walker_factor: 0
        altitude_km: 450
        inclination_deg: 70.0
        eccentricity: 0.5
        arg_perigee_deg: 0.0
        raan_spacing: uniform

      - name: LEO_AT
        enabled: false
        type: walker
        num_planes: 6
        sats_per_plane: 10
        walker_factor: 0
        altitude_km: 800
        inclination_deg: 60.0
        eccentricity: 0.001
        arg_perigee_deg: 0.0
        raan_spacing: uniform

      - name: MEO_EW
        enabled: false
        type: walker
        num_planes: 5
        sats_per_plane: 3
        walker_factor: 0
        altitude_km: 8000
        inclination_deg: 60.0
        eccentricity: 0.001
        arg_perigee_deg: 0.0
        raan_spacing: uniform

      - name: MEO_AT
        enabled: false
        type: walker
        num_planes: 3
        sats_per_plane: 8
        walker_factor: 1
        altitude_km: 23222
        inclination_deg: 56.0
        eccentricity: 0.001
        arg_perigee_deg: 0.0
        raan_spacing: uniform


      - name: GEO_EW
        enabled: false
        type: walker
        num_planes: 1
        sats_per_plane: 3
        walker_factor: 0
        altitude_km: 35786
        inclination_deg: 0.0
        eccentricity: 0.0
        arg_perigee_deg: -75.0
        raan_spacing: 75

      - name: GEO_AT
        enabled: false
        type: walker
        num_planes: 1
        sats_per_plane: 6
        walker_factor: 0
        altitude_km: 35786
        inclination_deg: 0.0
        eccentricity: 0.0
        arg_perigee_deg: 10.0
        raan_spacing: uniform

      - name: HEO_AT
        enabled: false
        type: walker
        num_planes: 2
        sats_per_plane: 4
        walker_factor: 0
        altitude_km: 20184
        inclination_deg: 63.4
        eccentricity: 0.74
        arg_perigee_deg: 270.0
        raan_spacing: uniform

    propagation:
      method: RK4
      include_J2: false
      timestep_sec: 1.0
      duration_min: 20

    output:
      coordinate_frame: ECEF
      save_ephemeris: true
      ephemeris_dir: exports/ephemeris/
      file_format: csv

geometry:
  mission:
    sat_dir: flightdynamics/exports/ephemeris        # Raw satellite ephemeris base
    sat_aligned_base: exports/aligned_ephems/satellite_ephems/  # Aligned satellite root
    tgt_aligned_base: exports/aligned_ephems/targets_ephems    # Aligned target root
    los_output_dir: exports/geometry/los             # Output directory for LOS CSVs
    sat_pattern: "*.csv"                              # Glob pattern for satellites
    tgt_pattern: "HGV_*.csv"                         # Glob pattern for targets
    join_mode: nearest                               # Join strategy (nearest|inner)
    nearest_tol_s: 0.2                               # Max time delta for nearest join (s)
    write_access: true                               # Allow overwriting outputs
    earth_radius_m: 6378137.0                        # Mean Earth radius used for visibility checks
  gpm:
    triangulator: nsats       # Triangulation backend: two_sats|nsats
    mode_all_pairs: true         # True: evaluate all satellite pairs, else fixed pair
    sat_a: null                  # Optional fixed satellite A identifier
    sat_b: null                  # Optional fixed satellite B identifier
    min_overlap_epochs: 3        # Minimum common epochs required for a pair
    save_empty_pairs: false      # Persist CSV even if no triangulated samples
    name_with_pair: true         # Include satellite pair in output filename
    sigma_urad: 30.0            # Measurement noise std (µrad) for injected noise
    beta_min_deg: 1.0            # Minimum geometry angle threshold (degrees)
    big_cov_km2: 1.0e6           # Fallback covariance variance (km^2)
    reg_eps: 1.0e-12             # Regularization for information matrix inversion
    seed: null                   # RNG seed for noise injector (None → random)

estimation:
  run_filter:
    max_epochs: null          # Optional limit on the number of measurements per target
    jerk_psd: 1.0e-4          # Process noise spectral density (km^2/s^5)
    p0_scale: 1.0             # Scaling factor for initial covariance P0
    log_level: INFO           # Console logging threshold (DEBUG/INFO/…)
    backend: filterpy          # Filtering backend: smooth_ca|adaptive|filterpy|legacy
    track_update_rate_hz: null  # Optional output sampling rate (Hz); null → native measurement times
    adaptive:
      window_size: 21           # Number of samples in the sliding polynomial window (odd)
      huber_k: 2.5              # Huber threshold for robust weighting (dimensionless)
      min_weight: 1.0e-6        # Minimum per-sample weight to avoid degeneracy
    smooth_ca:
      chi2_gate_3dof: 7.815     # Chi-square gate threshold (3 DoF)
      force_update: false       # Force the measurement update even if gate fails
      min_meas_std_m: 75.0      # Floor on reported measurement standard deviation (m)
      min_p0_pos_std_m: 200.0   # Minimum position std-dev for the initial covariance (m)
      gate_reject_pos_factor: 4.0  # P inflation factor applied on gate rejection
      gate_rescue_factor: 9.0     # R inflation factor when trying to rescue gated measurements
      rescue_force_update: true   # Apply the measurement even if gate still fails after rescue
      max_abs_accel_kmps2: 0.1    # Clamp acceleration magnitude to avoid divergence (0 → disable)
      P0_diag: [1.0e-3, 1.0e-3, 1.0e-3, 0.5, 0.5, 0.5, 5.0, 5.0, 5.0]
      inflate:
        bad_geom_factor: 3.0        # Multiplier when geometry flagged as poor
        condA_thresh: 1.0e8         # Condition number threshold for inflation
        condA_factor: 2.0           # Multiplier when condA exceeds threshold
        betamin_thresh_deg: 10.0    # β_min threshold in degrees
        betamin_factor: 2.0         # Multiplier when β_min below threshold
  kf:
    chi2_gate_3dof: 7.815     # Chi-square gate for 3-DoF innovation test
    force_update: false       # Force updates even if innovation fails the gate
    P0_diag: [1.0e-3, 1.0e-3, 1.0e-3, 1.0, 1.0, 1.0, 10.0, 10.0, 10.0]  # Default diagonal of initial covariance
    min_meas_std_m: 100.0     # Floor on measurement position std-dev used by the KF (m)
    min_p0_pos_std_m: 100.0   # Minimum position std-dev for the initial covariance P0 (m)
    gate_reject_pos_factor: 9.0  # Inflation factor for position covariance when an update is rejected
    inflate:
      bad_geom_factor: 3.0        # Multiplier when geometry flagged as poor
      condA_thresh: 1.0e8         # Condition number threshold for inflation
      condA_factor: 2.0           # Multiplier when condA exceeds threshold
      betamin_thresh_deg: 10.0    # β_min threshold in degrees
      betamin_factor: 2.0         # Multiplier when β_min below threshold
  filterpy:
    estimator: kalman         # Backend estimator (kalman|ekf|ukf|imm)
    ukf:
      alpha: 0.3              # Unscented transform spread parameter
      beta: 2.0               # Prior knowledge about distribution (2 for Gaussian)
      kappa: 0.0              # Secondary scaling parameter
    imm:
      models:
        - name: nominal
          jerk_psd_scale: 1.0
        - name: maneuver
          jerk_psd_scale: 10.0
      transition:
        - [0.95, 0.05]
        - [0.05, 0.95]
      mu0: [0.9, 0.1]         # Initial mode probabilities (must match number of models)

filter:
  name: KF_CV_9state
  state_dimension: 9
  measurement_dof: 3

comms:
  gs1: ["A", 42.2, 6.1, 0]
  gs2: ["B", 52.2, 12.1, 0]
#  gs3: ["C", 40.5, 20.8, 0]
#  gs4: ["D", 78.5, 18.5, 0]
#  gs5: ["E", 53.1, 21.2, 0]
#  gs6: ["F", 60.2, 9.4, 0]
  gs7: ["G", 40.2, -4.5, 0]

policies:
  gnd-sat:
    min_elevation_deg: 5.0
    max_range_m: 2.0e8      # 200,000 km
    setup_delay_s: 0.0
  sat-sat:
    max_range_m: 8.0e7      # 80,000 km
    setup_delay_s: 0.0

reporting:
  report_generation:
    title_prefix: ""
    filename_suffix: ""
    theme: light
    colorscale: Viridis
    annotation: ""

logging:
  level: INFO                 # Global logging level applied by modules that honour it
